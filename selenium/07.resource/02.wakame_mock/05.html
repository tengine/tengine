<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head profile="http://selenium-ide.openqa.org/profiles/test-case">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link rel="selenium.base" href="http://localhost/" />
<title>03_00_01_00_00_00</title>
</head>
<body>
<table cellpadding="1" cellspacing="1" border="1">
<thead>
<tr><td rowspan="1" colspan="3">03_00_01_00_00_00</td></tr>
</thead><tbody>
<!--[正常系]アプリケーション運用者は仮想サーバ起動起動後すぐにあらたな仮想サーバの起動を試みる-->
<!--下準備-->
<tr>
	<td>open</td>
	<td>/tengine/test/scripts</td>
	<td></td>
</tr>
<tr>
	<td>setTimeout</td>
	<td>120000</td>
	<td></td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>link=スクリプト一覧</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>[<br /> Tengine::Test::Script,<br /> Tengine::Resource::Credential,<br /> Tengine::Resource::Provider,<br /> Tengine::Core::Event<br />].map(&amp;:delete_all)</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengined\<br />&nbsp;&nbsp;-k stop\<br />&nbsp;&nbsp;-f ./features/config/tengined.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengined\<br />&nbsp;&nbsp;-k force_stop\<br />&nbsp;&nbsp;-f ./features/config/tengined.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengine_resource_watchd\<br />&nbsp;&nbsp;-k stop\<br />&nbsp;&nbsp;-f ./features/config/resource_watchd.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengine_resource_watchd\<br />&nbsp;&nbsp;-k force_stop\<br />&nbsp;&nbsp;-f ./features/config/resource_watchd.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<!--TengineリソースでTamaのテストモードを使用するため、Tengine::Resource::Provider#connection_settingsに設定する-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>rails runner\<br />&nbsp;&nbsp;features/usecases/アプリケーション運用者が仮想サーバを制御する/scripts/create_providor_wakame_test.rb\<br />&nbsp;&nbsp;features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files\<br />&nbsp;&nbsp;-e production</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=backquote</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<!--仮想サーバ、物理サーバ、仮想サーバイメージ、仮想サーバタイプのデータを全削除する-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>rails runner\<br />&nbsp;&nbsp;features/usecases/アプリケーション運用者が仮想サーバを制御する/scripts/delete_all_resources.rb\<br />&nbsp;&nbsp;-e production</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=backquote</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<!--"Tengineコア"プロセスを起動している(ジョブの実行は行わないので読み込むDSLはエラーにならなければどれでもよい)-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>rm tmp/tengined_status/*</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengined \<br />&nbsp;&nbsp;-T usecases/job/dsl/1001_one_job_in_jobnet.rb \<br />&nbsp;&nbsp;-f ./features/config/tengined.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=spawn</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>require 'timeout'<br />results = []<br />timeout(30) do<br />&nbsp;&nbsp;loop do<br />&nbsp;&nbsp;&nbsp;&nbsp;result = `bundle exec tengined -k status`.chomp<br />&nbsp;&nbsp;&nbsp;&nbsp;results &lt;&lt; result<br />&nbsp;&nbsp;&nbsp;&nbsp;break if result.each_line.grep(/running/).count.nonzero?<br />&nbsp;&nbsp;end<br />end<br />results</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/table/tbody/tr[2]/td[5]</td>
	<td>regexp:running</td>
</tr>
<!--モックファイルをコピーする-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>cp\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/01_describe_host_nodes_10_physical_servers.json\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/describe_host_nodes.json</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>cp\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/10_describe_instances_0_virtual_servers.json\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/describe_instances.json</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>cp\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/21_describe_images_5_virtual_server_images.json\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/describe_images.json</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>cp\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/31_describe_instance_specs_4_virtual_server_specs.json\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/describe_instance_specs.json</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<!--"Tengineリソースウォッチャ"プロセスを起動する-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengine_resource_watchd\<br />&nbsp;&nbsp;-f ./features/config/resource_watchd.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=spawn</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<!--ファイルを置いたからといってすぐさま反映されるわけではないので、しばらく待つ-->
<tr>
	<td>clickAndWait</td>
	<td>link=仮想サーバ一覧</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=refresher_refresh_interval</td>
	<td>1</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>//div[@id='main']/div/div[2]/div/form/span/input</td>
	<td></td>
</tr>
<tr>
	<td>waitForXpathCount</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr</td>
	<td>10</td>
</tr>
<tr>
	<td>refreshAndWait</td>
	<td></td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=refresher_refresh_interval</td>
	<td>0</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>//div[@id='main']/div/div[2]/div/form/span/input</td>
	<td></td>
</tr>
<!--確認-->
<tr>
	<td>assertText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[1]/th[1]</td>
	<td>物理サーバ名</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[1]</td>
	<td>仮想サーバ名</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[2]</td>
	<td>プロバイダによるID</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[3]</td>
	<td>説明</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[4]</td>
	<td>IPアドレス</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[5]</td>
	<td>ステータス</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[6]</td>
	<td>仮想サーバイメージ名</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/thead/tr[2]/th[7]</td>
	<td>仮想サーバタイプ</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[1]/td[1]</td>
	<td>physical_server_name_01</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[1]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[2]/td[1]</td>
	<td>physical_server_name_02</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[2]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[3]/td[1]</td>
	<td>physical_server_name_03</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[3]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[4]/td[1]</td>
	<td>physical_server_name_04</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[4]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[5]/td[1]</td>
	<td>physical_server_name_05</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[5]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[6]/td[1]</td>
	<td>physical_server_name_06</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[6]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[7]/td[1]</td>
	<td>physical_server_name_07</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[7]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[8]/td[1]</td>
	<td>physical_server_name_08</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[8]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[9]/td[1]</td>
	<td>physical_server_name_09</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[9]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[10]/td[1]</td>
	<td>physical_server_name_10</td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div[2]/form/table/tbody/tr[10]/td[2]</td>
	<td>仮想サーバは起動していません。</td>
</tr>
<!--Tengineリソースウォッチャを停止した状態で仮想サーバの起動処理を複数回実行する-->
<tr>
	<td>openAndWait</td>
	<td>/tengine/test/scripts</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>bundle exec tengine_resource_watchd\<br />&nbsp;&nbsp;-k stop\<br />&nbsp;&nbsp;-f ./features/config/resource_watchd.yml.erb</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<!--仮想サーバを1台起動-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>cp\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/41_run_instances_1_virtual_servers.json\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/run_instances.json</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>openAndWait</td>
	<td>/tengine/resource/virtual_servers/new</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=virtual_server_name</td>
	<td>run_1_virtual_server</td>
</tr>
<tr>
	<td>select</td>
	<td>id=virtual_server_host_server_id</td>
	<td>label=physical_server_name_01</td>
</tr>
<tr>
	<td>select</td>
	<td>id=virtual_server_provided_image_id</td>
	<td>label=virtual_server_image_uuid_01</td>
</tr>
<tr>
	<td>select</td>
	<td>id=virtual_server_provided_type_id</td>
	<td>label=virtual_server_spec_uuid_01(CPUコア数:1, メモリサイズ:256MB)</td>
</tr>
<tr>
	<td>type</td>
	<td>id=virtual_server_starting_number</td>
	<td>1</td>
</tr>
<tr>
	<td>type</td>
	<td>id=virtual_server_description</td>
	<td>仮想サーバを1台起動テストの説明</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div/div/ul/li</td>
	<td>virtual_server_uuid_91</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>link=スクリプト一覧</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>path = Rails.configuration.paths['log'].first<br />fmt = Regexp.new(Regexp.quote(&lt;&lt;'END'))<br />Tama::Controllers::TamaTestController#run_instances(&quot;virtual_server_image_uuid_01&quot;, 1, 1, [], nil, &quot;&quot;, nil, &quot;virtual_server_spec_uuid_01&quot;, nil, nil, &quot;physical_server_uuid_01&quot;, nil)<br />END<br />File.open path, 'r' do |fp|<br />&nbsp;&nbsp;fp.each_line.grep(fmt).count.nonzero?<br />end</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>verifyNotText</td>
	<td>//div[@id='main']/div/table/tbody/tr[2]/td[5]</td>
	<td>---<br />result: !!null</td>
</tr>
<!--さらに仮想サーバを1台起動-->
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>cp\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/43_run_instances_1_virtual_servers_other_aws_id.json\<br />&nbsp;&nbsp;./features/usecases/アプリケーション運用者が仮想サーバを制御する/test_files/run_instances.json</td>
</tr>
<tr>
	<td>select</td>
	<td>id=script_kind</td>
	<td>label=system</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>openAndWait</td>
	<td>/tengine/resource/virtual_servers/new</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=virtual_server_name</td>
	<td>run_1_virtual_server_again</td>
</tr>
<tr>
	<td>select</td>
	<td>id=virtual_server_host_server_id</td>
	<td>label=physical_server_name_01</td>
</tr>
<tr>
	<td>select</td>
	<td>id=virtual_server_provided_image_id</td>
	<td>label=virtual_server_image_uuid_01</td>
</tr>
<tr>
	<td>select</td>
	<td>id=virtual_server_provided_type_id</td>
	<td>label=virtual_server_spec_uuid_01(CPUコア数:1, メモリサイズ:256MB)</td>
</tr>
<tr>
	<td>type</td>
	<td>id=virtual_server_starting_number</td>
	<td>1</td>
</tr>
<tr>
	<td>type</td>
	<td>id=virtual_server_description</td>
	<td>仮想サーバを1台起動テストの説明</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>verifyText</td>
	<td>//div[@id='main']/div/div/div/ul/li</td>
	<td>virtual_server_uuid_97</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>link=スクリプト一覧</td>
	<td></td>
</tr>
<tr>
	<td>type</td>
	<td>id=script_code</td>
	<td>path = Rails.configuration.paths['log'].first<br />fmt = Regexp.new(Regexp.quote(&lt;&lt;'END'))<br />Tama::Controllers::TamaTestController#run_instances(&quot;virtual_server_image_uuid_01&quot;, 1, 1, [], nil, &quot;&quot;, nil, &quot;virtual_server_spec_uuid_01&quot;, nil, nil, &quot;physical_server_uuid_01&quot;, nil)<br />END<br />File.open path, 'r' do |fp|<br />&nbsp;&nbsp;fp.each_line.grep(fmt).count.nonzero?<br />end</td>
</tr>
<tr>
	<td>clickAndWait</td>
	<td>name=commit</td>
	<td></td>
</tr>
<tr>
	<td>verifyNotText</td>
	<td>//div[@id='main']/div/table/tbody/tr[2]/td[5]</td>
	<td>---<br />result: !!null</td>
</tr>
</tbody></table>
</body>
</html>
