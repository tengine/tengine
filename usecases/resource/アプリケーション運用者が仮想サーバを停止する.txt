ユースケース名:
  アプリケーション運用者が仮想サーバを停止する

背景:
  分散バッチを実行したあと、使用しなくなった仮想サーバは速やかにシャットダウンする必要がある。
  その際、仮想サーバ上に配置されたログファイル等を退避させる必要がある。
  このユースケースでは、仮想サーバを安全にシャットダウンするところを扱う。

概要:
  アプリケーション運用者は、[仮想サーバー制御画面]で仮想サーバを確認した上で、停止する仮想サーバを
  Tengineに指示する。
  Tengineは仮想サーバ基盤にその内容を指示して、仮想サーバ基盤は仮想サーバの停止を行う。

事前条件:
  分散バッチの実行が完了している
  停止対象の仮想サーバ群が起動している
  Tengineコアが起動している
  仮想サーバ基盤が起動している

成功時保証:
  アプリケーション運用者が分散バッチで使用した仮想マシンがシャットダウンできていることを確認できる

最低保証:
  なし

登場する画面:
  仮想サーバー制御画面

登場するコンポーネント:
  なし

登場するパッケージ:

登場するドキュメント:

基本コース:
 1. アプリケーション運用者は「仮想サーバー制御画面」を開く。<戻り点: 仮想サーバー制御画面の表示>
 2. {アプリケーション運用者が仮想サーバの状態を取得する}に遷移する。
 3. {アプリケーション運用者が物理サーバの状態を取得する}に遷移する。
 4. アプリケーション運用者は「仮想サーバー制御画面」を確認して、どの仮想サーバを停止するのか決める。
 5. アプリケーション運用者は「仮想サーバー制御画面」の停止したい対象の「停止ボタン」を押下する[代替コースA][代替コースB][代替コースE]
 6. 「仮想サーバー制御画面」はTengineにどの仮想サーバを停止するかを指示する。<戻り点:仮想サーバの停止リクエスト>
 7. Tengineは仮想サーバー基盤にどの仮想サーバを停止するかを指示する。
 8. 仮想サーバ基盤は指定された仮想サーバに停止を指示し、要求された仮想サーバ群の情報をTengineに報告する。
 9. Tengineは「仮想サーバー制御画面」に要求された仮想サーバ群の情報を報告する。
10. 「仮想サーバー制御画面」は要求された仮想サーバ群の情報を出力する。
11. アプリケーション運用者は「仮想サーバ制御画面」で停止を指示したすべての仮想サーバが停止し終えるの待つ。<戻り点：仮想サーバの停止確認>[代替コースC][代替コースD]

代替コースA: 停止対象をチェックボックスで選択し、複数の仮想サーバ群を停止する
 1. アプリケーション運用者は停止したい対象の仮想サーバ群のチェックボックスにチェックを入れ、「選択したサーバーを停止ボタン」を押下する
 2. <戻り点:仮想サーバの停止リクエスト>に遷移する

代替コースB: 全選択チェックボックスで全仮想サーバにチェックを入れ、複数の仮想サーバ群を停止する
 1. アプリケーション運用者は全選択のチェックボックスにチェックし、「選択したサーバーを停止ボタン」を押下する
 2. <戻り点:仮想サーバの停止リクエスト>に遷移する

代替コースC: 仮想サーバーの状態が変わらない（Tengineリソースウォッチャプロセスが落ちている）
 # 定期的にプロバイダの管理下にあるリソースの状態を問い合わせるTengineリソースウォッチャプロセスが停止している場合、
 # サーバーの状態は仮想サーバーの状態は更新されない
 1. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログを確認する。
 2. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログから、Tengineリソースウォッチャに問題があることを確認する。
 3. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログを元に問題を取り除く。
 4. アプリケーション運用者はコアサーバでTengineリソースウォッチャのプロセスを起動する。
 5. アプリケーション運用者はコアサーバでTengineリソースウォッチャのプロセスが起動していることを確認する。
 6. <戻り点：仮想サーバの停止確認>に遷移する。

代替コースD: 仮想サーバーの状態が変わらない（仮想サーバ基盤が落ちている）
 1. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログを確認する。
 2. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログから、仮想サーバ基盤の接続に問題があることを確認する。
 3. アプリケーション運用者は仮想基盤サーバで仮想サーバ基盤のログを確認する。
 4. アプリケーション運用者は仮想基盤サーバで仮想サーバ基盤のログを元に問題を取り除く。
 5. アプリケーション運用者は仮想基盤サーバで仮想サーバ基盤を起動する。
 6. アプリケーション運用者は仮想基盤サーバで仮想サーバ基盤が起動していることを確認する。
 7. アプリケーション運用者はコアサーバでTengineリソースウォッチャのプロセスが起動していることを確認する
 8. <戻り点：仮想サーバの停止確認>に遷移する

代替コースE: 仮想サーバ基盤に停止指示を投げたが、他のユーザーも同じ仮想サーバの停止を行なっていた場合
 1. 他のアプリケーション運用者が対象の仮想サーバの停止を行う。
 2. アプリケーション運用者は「仮想サーバー制御画面」の停止したい対象の「停止ボタン」を押下する。
 3. 「仮想サーバー制御画面」はTengineにどの仮想サーバを停止するかを指示する。
 4. Tengineは仮想サーバー基盤にどの仮想サーバを停止するかを指示する。
 5. 仮想サーバ基盤は指定された仮想サーバが停止されているためにエラーのレスポンスをTengineに返却する。
 6. Tengineは「仮想サーバー起動画面」にエラーメッセージを返却する。
 7. アプリケーション運用者は「仮想サーバ起動画面」に「指定の仮想サーバはすでに停止しています」のメッセージが表示されることを確認する。
 8. アプリケーション運用者は「仮想サーバ制御画面」にて対象の仮想サーバが停止状態でになっていることを確認する。

# 代替コース: 全選択チェックボックスをチェックしても稼働中のサーバーが選択されない
# 代替コース: 仮想サーバに対応した「停止」をクリックしてもステータスが変わらない
# 代替コース: 「停止」をクリックした仮想サーバとは異なる仮想サーバのステータスが停止中に移行した
# 代替コース: 全選択チェックボックスをチェックし、「選択したサーバを停止」をクリックしたが、一部のサーバのみステータスが変わらない（物理サーバ毎にステータスが変わらないものがある／停止中に移行しないサーバがある）
