ユースケース名:
  アプリケーション運用者が仮想サーバを起動する

背景:
  分散バッチを実行するにはその実行環境をセットアップする必要がある。
  実行環境のセットアップは、
  ・構成するサーバを起動する作業
  ・設定を行う作業
  ・起動したサーバ上で実行する分散バッチをデプロイする作業
  に分けられる。このユースケースでは
  ・構成するサーバを起動する作業
  を扱う。

  構成する仮想サーバを起動し設定を行うに当たって、どの物理サーバ上で起動するのかを
  設定できなければならない。これは、例えばHadoopクラスタが動作する仮想サーバ群が
  ネットワーク的に離れた物理サーバ上で動作すると、ネットワーク的に近い場合に比べて
  余計に通信コストがかかってしまうためである。これを解決するために、仮想サーバを起動
  する際に物理サーバ（あるいは同じ物理サーバ）で仮想サーバを起動できるように指定する
  機能が必要である。

概要:
  アプリケーション運用者は、[物理サーバ一覧]で物理サーバを、また[仮想サーバ一覧]で
  物理サーバ上で起動している仮想サーバを確認した上で、起動する仮想
  サーバのイメージと台数、および利用する物理サーバを指定して起動をTengineに指示する。
  Tengineはサーバ仮想基盤にその内容を指示して、サーバ仮想基盤は仮想サーバの起動を開始する。

事前条件:
  Tengineがセットアップされている。
  Tengineと連携するサーバ仮想基盤がセットアップされている。
  制御対象の物理サーバが起動している。

成功時保証:
  アプリケーション運用者が指定した仮想サーバが全て起動していることを確認できる。

最低保証:
  なし

登場する画面:
  仮想サーバ一覧
  物理サーバ閲覧

登場するコンポーネント:
  なし

登場するパッケージ:

登場するドキュメント:

基本コース:
 1. アプリケーション運用者は「仮想サーバ一覧」を開く。<戻り点: 仮想サーバ一覧の表示>
 2. {アプリケーション運用者が仮想サーバの状態を取得する}に遷移する。
 3. {アプリケーション運用者が物理サーバの状態を取得する}に遷移する。
 4. アプリケーション運用者は「仮想サーバ一覧」の「イメージ管理」リンクをクリックして「仮想サーバイメージ一覧」に移動する。<戻り点：仮想サーバイメージ一覧の確認>
 5. 「仮想サーバイメージ一覧」はTengineに仮想サーバイメージの情報を問い合わせる。
 6. サーバ仮想基盤はTengineに管理下の仮想サーバイメージのスペック情報を返却する。
 7. Tengineは管理下の「仮想サーバイメージ一覧」に仮想サーバイメージの情報を返却する。
 8. 「仮想サーバイメージ一覧」は仮想サーバイメージの情報を出力する。
 9. アプリケーション運用者は「仮想サーバイメージ一覧」を確認する。[代替コースA]<戻り点: 仮想サーバイメージのソート>
10. アプリケーション運用者はどの物理サーバでどのイメージの仮想サーバを何台起動するかを決める。
11. アプリケーション運用者は「仮想サーバ一覧」から、「仮想サーバを起動」ボタンを押下し、「仮想サーバ起動」画面に遷移する
12. アプリケーション運用者は「仮想サーバ起動」画面から物理サーバ名、仮想サーバ名、仮想サーバイメージ名、インスタンスタイプ、起動サーバ数を入力して「起動ボタン」を押下する[代替コースB][代替コースD]<戻り点:仮想サーバ起動画面表示>
13. Tengineはサーバ仮想基盤にどの物理サーバでどのイメージの仮想サーバを何台起動するのかを指示する。
14. サーバ仮想基盤は仮想サーバの起動を始めて、要求のあった仮想サーバ群の状態をTengineに報告する。
15. Tengineはサーバ仮想基盤から返却された仮想サーバ群の状態をリソースストアに登録する。
16. Tengineは要求のあった仮想サーバ群の状態を「仮想サーバ一覧」に返却する。
17. 「仮想サーバ一覧」は要求のあった仮想サーバ群の状態を出力する。
18. アプリケーション運用者は「イベント通知」画面で仮想サーバ起動リクエストイベントが通知されていることを確認する
19. アプリケーション運用者は「イベント通知」画面で仮想サーバ登録通知イベントが通知されていることを確認する
20. アプリケーション運用者はすべての仮想サーバが起動し終えるの待つ。<戻り点：仮想サーバの起動確認>[代替コースC][代替コースD]
21. アプリケーション運用者は「イベント通知」画面で仮想サーバ変更通知イベントが通知されていることを確認する

代替コースA: サーバ仮想基盤に登録されている仮想サーバイメージが0台である
 ## 利用可能な仮想サーバイメージが0台のときに画面表示に問題がないことを確認する。
 1. アプリケーション運用者は「仮想サーバイメージ一覧」で確認できる仮想サーバイメージが0台であることを確認する。
 2. アプリケーション運用者はサーバ仮想基盤に仮想サーバイメージが登録されていないことを確認する。
 3. アプリケーション運用者はサーバ仮想基盤に仮想サーバイメージを登録する。
 4. アプリケーション運用者は「イベント通知」画面で仮想サーバイメージ登録通知イベントが通知されていることを確認する
 5. アプリケーション運用者は「イベント通知」画面で仮想サーバイメージ変更通知イベントが通知されていることを確認する
 6. <戻り点: 仮想サーバ一覧の表示>に遷移する。

代替コースB: サーバ仮想基盤で管理している物理サーバに余力がなく、起動可能数が0である
 1. アプリケーション運用者は「仮想サーバ起動」画面で起動可能数が0であることを確認する。
 2. アプリケーション運用者は「仮想サーバ一覧」で不要な仮想サーバが起動していることを確認する。
 3. {アプリケーション運用者が仮想サーバを停止する}に遷移する
 4. <戻り点:仮想サーバ起動画面表示>に遷移する

代替コースC: 仮想サーバの起動が完了しない（Tengineリソースウォッチャプロセスが落ちている）
 # 定期的にプロバイダの管理下にあるリソースの状態を問い合わせるTengineリソースウォッチャプロセスが停止している場合、
 # サーバの状態は仮想サーバの状態は更新されない
 1. アプリケーション運用者は「イベント通知」画面で仮想サーバ変更通知イベントが通知されていないことを確認する
 2. アプリケーション運用者は「イベント通知」画面でリソースウォッチャのハートビートが届いていないことを確認する
 3. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログを確認する
 4. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログを元に問題を取り除く
 6. アプリケーション運用者はコアサーバでTengineリソースウォッチャのプロセスを起動する
 7. アプリケーション運用者はコアサーバでTengineリソースウォッチャのプロセスが起動していることを確認する
 8. <戻り点：仮想サーバの起動確認>に遷移する

代替コースD: サーバ仮想基盤に起動指示を投げたが、他のユーザーも仮想サーバの起動を行なっていたため、物理サーバの余力がなくなった場合
 # 送信時には上限に達していないにもかかわらず、同時に２つの仮想サーバ起動リクエストイベントが送られた場合、
 # 後から処理されるイベントの途中で処理が失敗することが考えられる。
 # Tengineはそのような場合でもプロバイダが返す仮想サーバの情報をリソースストアに反映する。
 1. アプリケーション運用者は「仮想サーバ起動」画面から物理サーバ名、仮想サーバ名、仮想サーバイメージ名、インスタンスタイプ、起動サーバ数を入力する。
 2. 他のアプリケーション運用者が仮想サーバを起動し、物理サーバの余力を使い切る。
 3. アプリケーション運用者は「仮想サーバ起動」画面から「起動」ボタンを押下する。
 4. Tengineはサーバ仮想基盤にどの物理サーバでどのイメージの仮想サーバを何台起動するのかを指示する。
 5. サーバ仮想基盤は仮想サーバの起動を始めて、要求のあった仮想サーバ群の状態をTengineに報告する。
 6. Tengineはサーバ仮想基盤から返却された仮想サーバ群の状態をリソースストアに登録する。
 7. アプリケーション運用者は「イベント通知」画面で仮想サーバ起動リクエストイベントが通知されていることを確認する
 8. サーバ仮想基盤は物理サーバに余力がないために仮想サーバの起動を行えない。
 9. Tengineは要求のあった仮想サーバ群の状態を「仮想サーバ一覧」画面に返却する。
10. アプリケーション運用者は「仮想サーバ一覧」画面にて起動指示を行った仮想サーバが起動しないことを確認する。

# 代替コース: 「仮想サーバ起動」画面で指定した仮想サーバが一台も起動しない
# 代替コース: 「仮想サーバ起動」画面で指定した台数より少ない台数の仮想サーバが起動した
# 代替コース: 「仮想サーバ起動」画面で指定した台数より多い台数の仮想サーバが起動した
# 代替コース: 「仮想サーバ起動」画面で指定した物理サーバとは異なる物理サーバから仮想サーバが起動した
# 代替コース: 「仮想サーバ起動」画面で指定したイメージとは異なるイメージ名が画面に表示された
# 代替コース: 仮想サーバの情報が一部取得できない（IPアドレス、ステータスを想定）
# 代替コース: 仮想サーバの起動が完了しない（サーバ仮想基盤の情報が更新されない／仮想サーバが指示なく停止する）

代替コース: 仮想サーバの状態が変わらない（サーバ仮想基盤が落ちている）
 # 仮想サーバ基盤側の問題で仮想サーバの状態が取得できない。(優先度は低い)
 1. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログを確認する。
 2. アプリケーション運用者はコアサーバでTengineリソースウォッチャのログから、サーバ仮想基盤の接続に問題があることを確認する。
 3. アプリケーション運用者は仮想基盤サーバでサーバ仮想基盤のログを確認する。
 4. アプリケーション運用者は仮想基盤サーバでサーバ仮想基盤のログを元に問題を取り除く。
 5. アプリケーション運用者は仮想基盤サーバでサーバ仮想基盤を起動する。
 6. アプリケーション運用者は仮想基盤サーバでサーバ仮想基盤が起動していることを確認する。
 7. アプリケーション運用者はコアサーバでTengineリソースウォッチャのプロセスが起動していることを確認する
 8. <戻り点：仮想サーバの停止確認>に遷移する
