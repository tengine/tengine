ユースケース名:
  アプリケーション開発者がTengineを運用に耐えられるか検証する

背景:
  Tengineを実運用できるか検証するために、アプリケーション開発者がTengineの開発環境でジョブの実行を試してみる。
  運用の容易さの評価項目
    * インストールからセットアップ、起動までの作業手順が容易であること(未記載)
    * アプリケーションやTengineが利用するプロセスに問題が発生した際の原因の調査方法が容易であること(記載済)
  ジョブ実行の評価項目
    * 循環参照や存在しない参照など、実行不可能なジョブネット定義の検出が可能であること

概要:
  Tengineの開発環境は構築済みである。
  アプリケーション運用者が確認をする項目は以下を想定している。
  * 大量の標準出力、標準エラー出力があるジョブ
  * 複雑で大きなジョブネットの生成が遅い
	* 循環参照
  * expansion
    * 存在しないルートジョブネットの参照
    * 相互参照
	  * 自分自身の参照
  * 環境変数
    * MM_FULL_ACTUAL_JOB_ANCESTOR_IDS
    * MM_ACTUAL_JOB_ANCESTOR_IDS
  * ジョブプロセスウォッチャが動作中にコアやキュー、ネットワーク、ジョブプロセスウォッチャ自身やジョブプロセスウォッチャが稼働サーバがダウンする
  * ジョブ実行中にコアやキュー、ネットワーク、ジョブプロセスウォッチャ自身やジョブプロセスウォッチャが稼働サーバがダウンする

  ジョブ実行中にジョブ実行サーバがダウンした場合の仕様は、当面実現できるか不明です。

事前条件:
  DBプロセスが起動している
  キューのプロセスが起動している
  Tengineコアが起動している
  Tengineコンソールが起動している

成功時保証:
  アプリケーション開発者がTengineのジョブ実行で問題が発生したことが確認できる

最低保証:
  なし

登場するコンポーネント:
  イベント管理画面
  ジョブ管理画面

登場するパッケージ:
  Tengineコア
  Tengineコンソール
  Tengineジョブプロセスウォッチャ  
  
参照するドキュメント:
  Getting Started
  アプリケーション開発者向けTengineマニュアル
  アプリケーション運用者向けTengineマニュアル

基本コース:

アプリケーション開発者は仮想サーバを起動する
アプリケーション開発者はジョブテスト起動する
アプリケーション開発者はジョブテストが正常に終了したことを確認する

#ジョブ制御ドライバがジョブ実行するマシンにsshで接続する際にネットワークが切れた場合_起動していない
アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行する
「名前検討」は仮想サーバにsshで接続し、ジョブプロセスウォッチャを起動する前にネットワークを切断する
アプリケーション開発者は「実行ジョブ一覧画面」を確認し、ジョブが異常終了していることを確認する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、ジョブが実行されていないことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#ジョブ制御ドライバがジョブ実行するマシンにsshで接続する際にネットワークが切れた場合_起動したがPIDを返せない
アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行する
「名前検討」は仮想サーバにsshで接続し、ジョブプロセスウォッチャに伝わって、コマンドを実行し、Pidを返す前にネットワークを切断する
アプリケーション開発者は「実行ジョブ一覧画面」を確認し、ジョブが異常終了していることを確認する #どうなる???
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、ジョブが実行されていることを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#ジョブ制御ドライバがジョブ実行するマシンにsshで接続する際にネットワークが切れた場合_起動しない_リトライ設定あり
アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行する
「名前検討」は仮想サーバにsshで接続し、ジョブプロセスウォッチャに伝わる前にネットワークを切断する
アプリケーション開発者はリトライ回数内にネットワークを接続する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが正常に終了したことを確認する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、ジョブが実行されていることを確認する
アプリケーション開発者はアプリケーションログを確認し、リトライを行ったことを確認する

#ジョブ制御ドライバがジョブ実行するマシンにsshで接続する際にネットワークが切れた場合_起動したがPIDを返せない_リトライ設定あり
アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行する
「名前検討」は仮想サーバにsshで接続し、ジョブプロセスウォッチャに伝わって、コマンドを実行し、Pidを返す前にネットワークを切断する
アプリケーション開発者はリトライ回数内にネットワークを接続する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが正常に終了したことを確認する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、ジョブが実行されていること、起動要求があったが既に起動していたので無視したことをを確認する  #方法を考える必要があります

#ジョブプロセスウォッチャがキューとの接続が切れていても、リトライするか
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者はスクリプト実行中にキューを落とす
アプリケーション開発者はスクリプト実行中にジョブプロセスウォッチャのログを確認し、キューとの接続が切断されたことを確認する
アプリケーション開発者はスクリプトが終了するのを待つ
アプリケーション開発者はリトライ回数内にキューを起動する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、キューと接続されたことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが正常に終了したことを確認する

#キューが落ちている時間が長いため、リトライ回数分リトライしても接続ができなかった場合
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者はスクリプト実行中にキューを落とす
アプリケーション開発者はスクリプト実行中にジョブプロセスウォッチャのログを確認し、キューとの接続が切断されたことを確認する
アプリケーション開発者はスクリプトが終了するのを待つ
アプリケーション開発者はリトライが終わるまで待つ
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、キューに接続できなかったことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが異常終了したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する
#異常終了で良いのか考える キューが落ちている場合は、ジョブプロセスウォッチャから原因(標準・エラー出力)が伝えられない
#どうやって異常終了にするか考える

#ジョブ実行中にジョブを実行しているサーバが落ちた場合(当面できるか不明)
#Tengine_resourceを利用して、マシンの死活を検知する
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者はスクリプト実行中にジョブを実行しているサーバを停止する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブ実行サーバが落ちたために異常終了したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#ジョブ実行中にジョブを実行しているジョブプロセスウォッチャが落ちた場合
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者はスクリプト実行中にジョブを実行しているサーバを停止する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブプロセスウォッチャが落ちたために異常終了したことを確認する #別の監視システムによって監視する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#アプリケーション開発者はジョブプロセスウォッチャで実行しようとしたスクリプトがない場合 #権限がないとかも
アプリケーション開発者は「実行ジョブ一覧画面」から実行するスクリプトが存在しないジョブを実行する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、実行するスクリプトなかったことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブがシェルがないために異常終了したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#接続先が間違っている_or_起動していない
アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行する接続先マシンが存在しないジョブを実行する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが接続先マシンがないために異常終了したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#認証情報が間違っている
アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行するマシンの認証情報が間違っているジョブを実行する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが認証情報が間違っているために異常終了したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが異常終了した事を表すイベントが発火されていることを確認する

#アプリケーション開発者はジョブを強制停止する(ジョブ、ジョブネット、ルートジョブネット)
#{アプリケーション運用者が分散バッチを実行する}に記載済み

#アプリケーション開発者はジョブを強制停止する_キューが停止している_リトライ回数内に復旧しない(できるか不明)
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者は「ジョブ一覧画面」で実行中のジョブを強制停止する
アプリケーション開発者は強制停止実行中にキューを停止する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、キューとの接続が切れたことを確認する
アプリケーション開発者はリトライが終わるまで待つ
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、強制停止完了の通知に失敗したことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが強制停止したこと、Tengineコアへの接続に失敗して強制停止が成功したことを伝えるのに失敗したことを確認する #

#アプリケーション開発者はジョブを強制停止する_キューが停止している_リトライ回数内に復旧する
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者は「ジョブ一覧画面」で実行中のジョブを強制停止する
アプリケーション開発者は強制停止実行中にキューを停止する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、キューとの接続が切れたことを確認する
アプリケーション開発者はリトライ回数内にキューを起動する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、キューと接続したことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブを強制停止したことを確認する

#アプリケーション開発者はジョブを強制停止する_強制停止を行う際にスクリプトが正常終了している
アプリケーション開発者はイベントを発火してジョブを実行する
アプリケーション開発者はスクリプトが正常終了したタイミングで強制停止を行う
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、スクリプトが正常終了したこと、スクリプトが正常終了したことによって強制停止に失敗したことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが正常終了したことを確認する

#アプリケーション開発者は強制停止_接続先のマシンがダウンしている(マシンがダウンしている場合、強制停止を行いわないが、検知のタイミングによってはおこりうる)
#Tengine_resourceがサーバがダウンしたことを検知し、Tengineコアに伝える間に強制停止を行おうとした場合
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者はジョブを実行しているサーバを停止する
アプリケーション開発者は「ジョブ一覧画面」で実行中のジョブを強制停止する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが異常終了したこと、接続に失敗して強制停止に失敗したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブの強制停止が失敗した事を表すイベントが発火されていることを確認する

#強制停止する際にネットワークの接続が切れた場合、強制停止実行前
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者は「ジョブ実行画面」で実行中のジョブを強制停止する
アプリケーション開発者は、強制停止のコマンドが実行される前にsshを停止する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、何も操作がきていないことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブを実行しているマシンへの接続に失敗したことによってジョブの強制停止に失敗したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブの強制停止が失敗した事を表すイベントが発火されていることを確認する

#強制停止する際にネットワークの接続が切れた場合、強制停止実行後
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者は「ジョブ実行画面」で実行中のジョブを強制停止する
アプリケーション開発者は、強制停止のコマンドが実行したあとににsshを停止する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、強制停止をしたことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが強制停止したことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが失敗した事を表すイベントが発火されていることを確認する

#強制停止する際にネットワークの接続が切れた場合、強制停止実行前_リトライあり
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者は「ジョブ実行画面」で実行中のジョブを強制停止する
アプリケーション開発者は、強制停止のコマンドが実行される前にsshを停止する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、何も操作がきていないことを確認する
アプリケーション開発者は、リトライ間隔だけ待つ
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、強制終了を行ったことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが強制停止したことを確認する

#強制停止する際にネットワークの接続が切れた場合、強制停止実行後_リトライあり
アプリケーション開発者は「実行ジョブ一覧画面」から時間のかかる(sleepが長い)ジョブを実行する
アプリケーション開発者は「ジョブ実行画面」で実行中のジョブを強制停止する
アプリケーション開発者は、強制停止のコマンドが実行したあとににsshを停止する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、強制停止をしたことを確認する
アプリケーション開発者は、リトライ間隔だけ待つ
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが強制停止したことを確認する
アプリケーション開発者はジョブプロセスウォッチャのログを確認し、強制終了の要求があったが、既に強制停止済みであったため強制停止要求を無視を行ったことを確認する
アプリケーション開発者は「イベント通知画面」を確認し、ジョブが失敗した事を表すイベントが発火されていることを確認する

#アプリケーション開発者はタイムアウト強制停止するとか
#強制停止と一緒

