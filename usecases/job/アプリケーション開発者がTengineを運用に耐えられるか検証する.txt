ユースケース名:
  アプリケーション開発者がTengineを運用に耐えられるか検証する

背景:
  Tengineを実運用できるか検証するために、アプリケーション開発者がTengineの開発環境でジョブの実行を試してみる。
  運用の容易さの評価項目
    * インストールからセットアップ、起動までの作業手順が容易であること(未記載)
    * アプリケーションやTengineが利用するプロセスに問題が発生した際の原因の調査方法が容易であること(記載済)
  ジョブ実行の評価項目
    * 循環参照や存在しない参照など、実行不可能なジョブネット定義の検出が可能であること

概要:
  Tengineの開発環境は構築済みである。
  アプリケーション運用者が確認をする項目は以下を想定している。
  * 大量の標準出力、標準エラー出力があるジョブ
  * 複雑で大きなジョブネットの生成が遅い
	* 循環参照
  * expansion
    * 存在しないルートジョブネットの参照
    * 相互参照
	  * 自分自身の参照
  * 環境変数
    * MM_FULL_ACTUAL_JOB_ANCESTOR_IDS
	  * MM_ACTUAL_JOB_ANCESTOR_IDS
  * エージェントが動作中にコアやキュー、ネットワーク、エージェント自身やエージェントが稼働サーバがダウンする
  * ジョブ実行中にコアやキュー、ネットワーク、エージェント自身やエージェントが稼働サーバがダウンする

事前条件:
  DBプロセスが起動している
  キューのプロセスが起動している
  Tengineコアが起動している
  Tengineコンソールが起動している
  Tengineジョブエージェントが起動している

成功時保証:
  アプリケーション開発者がTengineのジョブ実行で問題が発生したことが確認できる

最低保証:
  なし

登場するコンポーネント:
  イベント管理画面
  ジョブ管理画面

登場するパッケージ:
  Tengineコア
  Tengineコンソール
  Tengineジョブエージェント  
  
参照するドキュメント:
  Getting Started
  アプリケーション開発者向けTengineマニュアル
  アプリケーション運用者向けTengineマニュアル

基本コース:

#エージェント稼働中にいろいろ落とす
アプリケーション開発者はDBを起動させる
アプリケーション開発者はキューを起動させる
アプリケーション開発者はTengineコアを起動させる
アプリケーション開発者は仮想サーバを起動させる
アプリケーション開発者はエージェントを起動させる
アプリケーション開発者はジョブテスト起動する
アプリケーション開発者はジョブテストが正常に終了したことを確認する

アプリケーション開発者はキューを終了させる
アプリケーション開発者はエージェントのログを確認し、キューとの接続が切断されたことを確認する
アプリケーション開発者はキューを起動させる
アプリケーション開発者はエージェントのログを確認し、キューと接続されたことを確認する

アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行(コマンド実行前と実行後の二種類)
アプリケーション開発者は仮想サーバにsshが接続されて、エージェントに伝わる前にネットワークを切断する
アプリケーション開発者はエージェントのログを確認し、ジョブが実行されていないことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」を確認し、ジョブが失敗していることを確認する

アプリケーション開発者は「実行ジョブ一覧画面」からジョブを実行する
アプリケーション開発者は仮想サーバにsshが接続されて、エージェントに伝わって、コマンドを実行し、Pidを返す前にネットワークを切断する
アプリケーション開発者はエージェントのログを確認し、ジョブが実行されていることを確認する
アプリケーション開発者は「実行ジョブ一覧画面」を確認し、ジョブが失敗していることを確認する #どうなる???

アプリケーション開発者はイベントを発火して時間のかかる(sleepが長い)ジョブ実行する
アプリケーション開発者はスクリプト実行中にキューを落とす
アプリケーション開発者はスクリプト実行中にログを確認し、キューとの接続が切断されたことを確認する
アプリケーション開発者はスクリプトが終了するのを待つ
アプリケーション開発者はリトライ回数内にキューを起動する
アプリケーション開発者はログを確認し、キューと接続されたことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが正常に終了したことを確認する

#キューが落ちている時間が長いため、リトライ回数分リトライしても接続ができなかった場合
アプリケーション開発者はイベントを発火して時間のかかる(sleepが長い)ジョブ実行する
アプリケーション開発者はスクリプト実行中にキューを落とす
アプリケーション開発者はスクリプト実行中にログを確認し、キューとの接続が切断されたことを確認する
アプリケーション開発者はスクリプトが終了するのを待つ
アプリケーション開発者はリトライが終わるまで待つ
アプリケーション開発者はログを確認し、キューに接続できなかったことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが異常終了したことを確認する
#異常終了で良いのか考える キューが落ちている場合は、エージェントから原因(標準・エラー出力)が伝えられない


#アプリケーション開発者はエージェントで実行しようとしたスクリプトがない場合
アプリケーション開発者はイベントを発火して実行するスクリプトが存在しないジョブ実行する
アプリケーション開発者はエージェントのログを確認し、実行するスクリプトなかったことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブがシェルがないために異常終了したことを確認する


#接続先が間違っている_or_起動していない
#エージェントの耐えられるかのユースケースじゃない？
アプリケーション開発者はイベントを発火して実行する接続先マシンが存在しないジョブ実行する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが接続先マシンがないために異常終了したことを確認する


#認証情報が間違っている
#エージェントの耐えられるかのユースケースじゃない？
アプリケーション開発者はイベントを発火して実行する認証情報が間違っているジョブ実行する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが認証情報が間違っているために異常終了したことを確認する


#アプリケーション開発者は強制停止するとか
#{アプリケーション運用者が分散バッチを実行する}に記載済み


#アプリケーション開発者は強制停止_接続先のマシンがダウンしている(マシンがダウンしている場合、強制停止を行いわないが、検知のタイミングによってはおこりうる)
アプリケーション開発者はイベントを発火して時間のかかる(sleepが長い)ジョブ実行する
アプリケーション開発者はスクリプトが終了するのを待つ
アプリケーション開発者はリトライが終わるまで待つ
アプリケーション開発者はログを確認し、キューに接続できなかったことを確認する
アプリケーション開発者は「実行ジョブ一覧画面」でジョブが異常終了したことを確認する


#アプリケーション開発者はタイムアウト強制停止するとか
#強制停止と一緒

アプリケーション開発者はログ確認

強制停止する際にネットワークの接続が切れた場合、実行前と実行後

標準・エラー出力がとれるか






1. アプリケーション開発者が運用テスト環境でTengineコアを
